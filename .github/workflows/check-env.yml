name: Check .env keys coherence

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  env-check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compare .env files
        id: env_check
        shell: bash
        run: |
          set -euo pipefail

          # Buscar todos los archivos .env* en la raíz
          mapfile -t ENV_FILES < <(find . -maxdepth 1 -type f -name '.env*' | sort)

          if [ ${#ENV_FILES[@]} -lt 2 ]; then
            MSG="ℹ️ Solo se encontró ${#ENV_FILES[@]} archivo(s) .env. Se necesitan al menos 2 para comparar."
            echo "ENV_RESULT<<EOF" >> "$GITHUB_ENV"
            echo -e "$MSG" >> "$GITHUB_ENV"
            echo "EOF" >> "$GITHUB_ENV"
            echo "has_missing=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Regex que acepta opcionalmente 'export ' y toma solo KEY=
          KEY_GREP='^(export[[:space:]]+)?[A-Za-z_][A-Za-z0-9_]*='

          # Construir universo de keys (unión de todas las keys)
          : > all_vars.txt
          for file in "${ENV_FILES[@]}"; do
            grep -E "$KEY_GREP" "$file" | cut -d'=' -f1 | sed 's/^export[[:space:]]\+//' >> all_vars.txt || true
          done
          sort -u all_vars.txt > unique_vars.txt

          REPORT=""
          HAS_MISSING=false

          # Detectar faltantes por archivo
          for file in "${ENV_FILES[@]}"; do
            name="$(basename "$file")"
            grep -E "$KEY_GREP" "$file" | cut -d'=' -f1 | sed 's/^export[[:space:]]\+//' | sort -u > current_vars.txt || true
            # comm requiere entradas ordenadas
            missing="$(comm -23 unique_vars.txt current_vars.txt || true)"

            if [ -n "$missing" ]; then
              REPORT+="### 🚨 Variables faltantes en \`$name\`:\n"
              while IFS= read -r var; do
                [ -n "$var" ] && REPORT+="- \`$var\`\n"
              done <<< "$missing"
              REPORT+="\n"
              HAS_MISSING=true
            fi
          done

          # Armar el resumen con conteo robusto (keys únicas válidas)
          FINAL_REPORT="## 🔍 Variables de Entorno - Faltan Variables\n\n"
          FINAL_REPORT+="### 📋 Archivos analizados:\n"
          for file in "${ENV_FILES[@]}"; do
            name="$(basename "$file")"
            var_count="$(grep -E "$KEY_GREP" "$file" | cut -d'=' -f1 | sed 's/^export[[:space:]]\+//' | sort -u | wc -l | tr -d ' ')"
            FINAL_REPORT+="- \`$name\` (${var_count} variables)\n"
          done

          if [ "$HAS_MISSING" = true ]; then
            FINAL_REPORT+="\n${REPORT}---\n💡 **Sugerencia**: Asegúrate de que todas las variables estén presentes en todos los archivos .env.\n"
            echo "ENV_RESULT<<EOF" >> "$GITHUB_ENV"
            # marcador opcional para localizar/actualizar fácilmente
            echo "<!-- env-check-report -->" >> "$GITHUB_ENV"
            echo -e "$FINAL_REPORT" >> "$GITHUB_ENV"
            echo "EOF" >> "$GITHUB_ENV"
            echo "has_missing=true" >> "$GITHUB_OUTPUT"
            # Si quieres que el check falle cuando haya faltantes, descomenta la siguiente línea:
            # exit 1
          else
            OKMSG="<!-- env-check-report -->\n✅ Todos los archivos .env tienen las mismas keys.\n\n${FINAL_REPORT}"
            echo "ENV_RESULT<<EOF" >> "$GITHUB_ENV"
            echo -e "$OKMSG" >> "$GITHUB_ENV"
            echo "EOF" >> "$GITHUB_ENV"
            echo "has_missing=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment missing variables in PR
        if: steps.env_check.outputs.has_missing == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const marker = '<!-- env-check-report -->';
            const body = process.env.ENV_RESULT || `${marker}\n❌ No se pudo generar el reporte.`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(comment =>
              (comment.user?.type === 'Bot' || comment.user?.login === 'github-actions[bot]') &&
              comment.body?.includes('env-check-report')
            );
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Remove old comment if no missing variables
        if: steps.env_check.outputs.has_missing == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const marker = '<!-- env-check-report -->';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(comment =>
              (comment.user?.type === 'Bot' || comment.user?.login === 'github-actions[bot]') &&
              comment.body?.includes(marker)
            );
            if (botComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id
              });
            }
